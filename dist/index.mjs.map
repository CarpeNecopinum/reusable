{"version":3,"file":"index.mjs","sources":["../src/reusable.ts","../src/shallow-equal.ts","../src/react-reusable.tsx"],"sourcesContent":["export type HookFn<HookValue = any> = () => HookValue;\nexport type StoreValueChangeCallback<HookValue> = (value: HookValue) => void;\nexport type StoresChangeCallback = () => void;\n\nexport class Store<HookValue = any> {\n  name: string;\n  subscribers: StoreValueChangeCallback<HookValue>[] = [];\n  cachedValue: HookValue | null = null;\n  constructor(private fn: HookFn<HookValue>) {\n    this.name = fn.name || 'Store';\n  }\n\n  getCachedValue() {\n    return this.cachedValue as HookValue;\n  }\n\n  useValue() {\n    this.cachedValue = this.fn();\n\n    return this.cachedValue as HookValue;\n  }\n\n  subscribe(callback: StoreValueChangeCallback<HookValue>) {\n    this.subscribers = [...this.subscribers, callback];\n    if (this.cachedValue != null) callback(this.getCachedValue())\n    return () => {\n      this.subscribers = this.subscribers.filter(sub => sub !== callback)\n    }\n  }\n\n  notify() {\n    this.subscribers.forEach(sub => sub(this.cachedValue as HookValue));\n  }\n}\n\nexport class Container {\n  stores = new Map<HookFn, Store>();\n  subscribers: StoresChangeCallback[] = [];\n  onStoresChanged(callback: StoresChangeCallback) {\n    this.subscribers = [...this.subscribers, callback];\n    return () => {\n      this.subscribers = this.subscribers.filter(item => item !== callback);\n    }\n  }\n  createStore(fn: HookFn) {\n    if (this.stores.has(fn)) {\n      throw new Error('Store already exist');\n    }\n    const store = new Store(fn);\n    this.stores.set(fn, store);\n    this.notifyStoresChanged();\n\n    return store;\n  }\n  getStore<HookValue>(fn: HookFn<HookValue>):Store<HookValue> {\n    if (!this.stores.has(fn)) {\n      throw new Error('Store doesn\\'t exist');\n    }\n    return <Store<HookValue>>this.stores.get(fn);\n  }\n  notifyStoresChanged() {\n    this.subscribers.forEach(sub => sub());\n  }\n  getStoresArray() {\n    const storesArray: Store<any>[] = [];\n\n    this.stores.forEach((store) => {\n      storesArray.push(store);\n    })\n    return storesArray;\n  }\n}\nexport const createContainer = () => new Container();\nlet defaultContainer = new Container();\nexport const getContainer = () => defaultContainer;\nexport const replaceContainer = (mockedContainer: Container) => defaultContainer = mockedContainer;\n","const hasOwn = Object.prototype.hasOwnProperty\n\nfunction is(x: any, y: any) {\n  if (x === y) {\n    return x !== 0 || y !== 0 || 1 / x === 1 / y\n  } else {\n    return x !== x && y !== y\n  }\n}\n\nexport type AreEqual<Value> = (a: Value, b: Value) => boolean;\n\nexport function shallowEqual(objA: any, objB: any) {\n  if (is(objA, objB)) return true\n\n  if (\n    typeof objA !== 'object' ||\n    objA === null ||\n    typeof objB !== 'object' ||\n    objB === null\n  ) {\n    return false\n  }\n\n  const keysA = Object.keys(objA)\n  const keysB = Object.keys(objB)\n\n  if (keysA.length !== keysB.length) return false\n\n  for (let i = 0; i < keysA.length; i++) {\n    if (!hasOwn.call(objB, keysA[i]) || !is(objA[keysA[i]], objB[keysA[i]])) {\n      return false\n    }\n  }\n\n  return true\n}\n","import * as React from 'react';\nimport { FunctionComponent, useState, useContext, useEffect } from 'react';\nimport { shallowEqual, AreEqual } from './shallow-equal';\nimport { Container, getContainer, Store as StoreClass, HookFn } from './reusable';\n\nconst ReusableContext = React.createContext<Container | null>(null);\n\nexport const ReusableProvider: FunctionComponent<{}> = ({ children }) => (\n  <ReusableContext.Provider value={getContainer()}>\n    <React.Fragment>\n      <Stores />\n      {children}\n    </React.Fragment>\n  </ReusableContext.Provider>\n);\nObject.defineProperty(ReusableProvider,'displayName', { value: 'ReusableProvider' });\n\nconst componentCache = new Map();\n\nconst createStoreComponent = (store: StoreClass<any>) => {\n  if (!componentCache.has(store)) {\n\n    const Component = React.memo(() => {\n      store.useValue();\n      \n      useEffect(() => store.notify(), [store.cachedValue]);\n      \n      return null;\n    });\n    \n    Object.defineProperty(Component,'name', { value: store.name });\n\n    componentCache.set(store, Component);\n  }\n    \n  return componentCache.get(store);\n};\n\nconst useContainer = () => {\n  const container = useContext(ReusableContext) as Container;\n\n  if (container === null) {\n    throw new Error('Are you trying to use Reusable without a ReusableProvider?');\n  }\n\n  return container;\n}\n\nconst Stores = () => {\n  const container = useContainer();\n  const [stores, setStores] = useState(() => container.getStoresArray());\n\n  useEffect(() => {\n    return container.onStoresChanged(() => {\n      setStores(container.getStoresArray());\n    });\n  }, []);\n\n  return (\n    <React.Fragment>\n      {stores.map((store: StoreClass<any>, index: number) => {\n        const StoreComponent = createStoreComponent(store);\n\n        return <StoreComponent key={index} store={store}/>;\n      })}\n    </React.Fragment>\n  )\n}\nObject.defineProperty(Stores,'displayName', { value: 'Stores' });\n\ntype SelectorFn<HookValue, SelectorValue> = (val: HookValue) => SelectorValue;\nconst identity = (val: any) => val;\n\nfunction useStore<HookValue, SelectorValue>(\n  fn: HookFn<HookValue>,\n  selector: SelectorFn<HookValue, SelectorValue>,\n  areEqual:AreEqual<SelectorValue>\n) {\n  const store = useContainer().getStore<HookValue>(fn);\n  React.useDebugValue('reusable');\n  const [localCopy, setLocalCopy] = useState<SelectorValue>(() => selector(store.getCachedValue()));\n\n  useEffect(() => {\n    return store.subscribe((newValue) => {\n      const selectedNewValue = selector(newValue);\n\n      if (!areEqual(selectedNewValue, localCopy)) {\n        setLocalCopy(() => selectedNewValue);\n      }\n    });\n  }, [store, localCopy, selector, areEqual]);\n\n  return localCopy;\n}\n\nexport function createStore<HookValue>(fn: HookFn<HookValue>) {\n  const store = getContainer().createStore(fn);\n\n  // overload return function:\n  function useStoreHook(): HookValue;\n\n  function useStoreHook<SelectorValue = HookValue>(\n    selector?: SelectorFn<HookValue, SelectorValue>,\n    areEqual?: AreEqual<SelectorValue>\n  ): SelectorValue;\n\n  function useStoreHook<SelectorValue = HookValue>(\n    selector?: SelectorFn<HookValue, SelectorValue>,\n    areEqual?: AreEqual<SelectorValue>\n  ) {\n    React.useDebugValue(store.name);  \n\n    return useStore(fn, selector || identity, areEqual || shallowEqual);\n  }\n  return useStoreHook;\n}\n\n// TBD:\n// export const reusableReducer = (reducer, initialValue, init, options) => {\n//   const fn = () => useReducer(reducer, initialValue, init);\n\n//   getStore().createUnit(fn, options);\n//   return (selector, areEqual) => useStore(fn, selector, areEqual);\n// };\n\n// export const reusableState = (init, options) => {\n//   const fn = () => useState(init);\n\n//   getStore().createUnit(fn, options);\n//   return (selector, areEqual) => useStore(fn, selector, areEqual);\n// };\n"],"names":["Store","constructor","fn","name","subscribers","cachedValue","this","getCachedValue","useValue","subscribe","callback","filter","sub","notify","forEach","Container","stores","Map","onStoresChanged","item","createStore","has","Error","const","store","set","notifyStoresChanged","getStore","get","getStoresArray","storesArray","push","createContainer","defaultContainer","getContainer","replaceContainer","mockedContainer","hasOwn","Object","prototype","hasOwnProperty","is","x","y","shallowEqual","objA","objB","keysA","keys","keysB","length","let","i","call","ReusableContext","React","ReusableProvider","Provider","value","Stores","children","defineProperty","componentCache","useContainer","container","useContext","useState","useEffect","setStores","map","index","StoreComponent","Component","createStoreComponent","key","identity","val","selector","areEqual","newValue","selectedNewValue","localCopy","setLocalCopy","useStore"],"mappings":"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"}